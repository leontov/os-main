# Kolibri Swarm Protocol / Протокол роя Kolibri / Kolibri 群体协议

**Copyright (c) 2025 Кочуров Владислав Евгеньевич**

---

## 1. Transport / Транспорт / 传输层

- TCP поверх IPv4.
- Каждое соединение инициируется узлом-отправителем (`kn_share_formula`) и завершается после передачи серии кадров HELLO + MIGRATE_RULE (+ необязательный ACK).
- Максимальный размер полезной нагрузки: 256 байт.

---

## 2. Frame Format / Формат кадра / 帧格式

```
+------------+----------------------+-------------------+
| Offset (B) | Field                | Description       |
+------------+----------------------+-------------------+
| 0          | Type (uint8)         | 1=HELLO, 2=MIGRATE_RULE, 3=ACK |
| 1          | Length (uint16, BE)  | Длина полезной нагрузки       |
| 3..N       | Payload              | Полезные данные               |
+------------+----------------------+-------------------+
```

Payload интерпретируется согласно типу сообщения.

---

## 3. Messages / Сообщения / 消息

### 3.1 HELLO (Type=1)
- **Payload:** `uint32 node_id` (big-endian).
- **Назначение:** идентифицирует отправителя и позволяет узлу-приёмнику вести статистику подключений.
- **API:** `kn_message_encode_hello`, `kn_message_decode`.

### 3.2 MIGRATE_RULE (Type=2)
- **Payload:**
  - `uint32 node_id`
  - `int32 a`
  - `int32 b`
  - `double fitness` (передаётся как 64-битный IEEE754 в big-endian)
- **Назначение:** доставить формулу с коэффициентами `a`, `b` и значением fitness.
- **API:** `kn_message_encode_formula`, `kn_message_decode`.
- **Обработка:** узел-приёмник обновляет свой пул формул и записывает событие в геном.

### 3.3 ACK (Type=3)
- **Payload:** `uint8 status` (0=OK, 1=ERROR).
- **Назначение:** необязательное подтверждение при асинхронных сценариях.
- **API:** `kn_message_encode_ack`, `kn_message_decode`.

---

## 4. Listener Lifecycle / Жизненный цикл слушателя / 监听器生命周期

1. `kn_listener_start` открывает TCP-сокет, включает `SO_REUSEADDR`, слушает порт.
2. `kn_listener_poll` с таймаутом (мс) блокируется до события `select`, принимает соединение, читает последовательность кадров.
3. Сообщения декодируются до последнего корректного пакета; MIGRATE_RULE возвращается немедленно (код возврата `1`).
4. `kn_listener_close` освобождает ресурсы.

---

## 5. Error Handling / Обработка ошибок / 错误处理

- Ошибки чтения/записи приводят к закрытию соединения и возврату `-1`.
- Некорректные длины полезной нагрузки → `kn_message_decode` возвращает `-1`.
- Соединение без валидных кадров считается неуспешным (возвращается `-1`).

---

## 6. Extending the Protocol / Расширение протокола / 协议扩展

1. Добавьте новый элемент в `KolibriNetMessageType`.
2. Расширьте `KolibriNetMessage` и сериализацию/десериализацию.
3. Обновите таблицу сообщений в этом документе.
4. Создайте модульные тесты в `tests/test_net.c` и интеграционные сценарии в `kolibri.sh`.

